{
	"id":"info.cemu.Cemu",
	"sdk":"org.freedesktop.Sdk",
	"runtime":"org.freedesktop.Platform",
	"runtime-version":"21.08",
	"command":"cemu",
	"finish-args":[
		"--share=ipc",
		"--socket=wayland",
		"--socket=x11",
		"--socket=pulseaudio",
		"--share=network",
		"--device=all",
		"--allow=multiarch",
		"--allow=bluetooth",
		"--env=WINEPREFIX=/var/data/wine",
		"--filesystem=host"
	],
	"add-extensions": {
		"org.freedesktop.Platform.Compat.i386": {
			"directory": "lib/i386-linux-gnu",
			"version": "21.08"
		},
		"org.freedesktop.Platform.Compat.i386.Debug": {
			"directory": "lib/debug/lib/i386-linux-gnu",
			"version": "21.08",
			"no-autodownload": true
		},
		"org.freedesktop.Platform.GL32": {
			"directory": "lib/i386-linux-gnu/GL",
			"version": "1.4",
			"versions": "21.08;1.4",
			"subdirectories": true,
			"no-autodownload": true,
			"autodelete": false,
			"add-ld-path": "lib",
			"merge-dirs": "vulkan/icd.d;glvnd/egl_vendor.d;OpenCL/vendors;lib/dri;lib/d3d;vulkan/explicit_layer.d;vulkan/implicit_layer.d",
			"download-if": "active-gl-driver",
			"enable-if": "active-gl-driver"
		}
	},
	"modules":[
		{
			"name":"lynx",
			"config-opts":[
				"--with-ssl"
			],
			"make-install-args":[
				"PREFIX=/app"
			],
			"sources":[
				{
					"type":"archive",
					"url":"https://invisible-mirror.net/archives/lynx/tarballs/lynx2.8.9rel.1.zip",
					"sha256":"db508863d5d8b0919b7e5ed2fa5d86fa9ecb01463b76bfc3446e12c69c059188"
				}
			]
		},
		{
			"name":"proton",
			"buildsystem":"simple",
			"build-commands":[
				"cd files && find . -type f -exec install -D \"{}\" \"/app/{}\" \\;"
			],
			"sources":[
				{
					"type":"archive",
					"url":"https://github.com/GloriousEggroll/proton-ge-custom/releases/download/GE-Proton7-14/GE-Proton7-14.tar.gz",
					"sha512":"3cbe99a2659dab1871cef0b50deb8cab4f101cc4d0531ed3d2cd7cf89dcee6aa08357b3d485e4260ab7a46af13bf6349daed16deb382cbadd5b2831ba7ad5503"
				}
			]
		},
		{
			"name":"cemu",
			"buildsystem":"simple",
			"build-commands":[
				"install apply_extra /app/bin",
				"install cemu-updater /app/bin",
				"install cemu /app/bin",
				"install /usr/bin/unzip /app/bin",
				"install -Dm644 --target-directory=/app/share/metainfo info.cemu.Cemu.appdata.xml",
				"install -Dm644 --target-directory=/app/share info.cemu.Cemu.desktop"
			],
			"sources":[
				{
					"type":"script",
					"dest-filename":"apply_extra",
					"commands":[
						"mkdir -p export/share/icons/hicolor/512x512/apps",
						"mv info.cemu.Cemu.png export/share/icons/hicolor/512x512/apps",
						"mkdir -p export/share/applications",
						"cp /app/share/info.cemu.Cemu.desktop export/share/applications",
						"echo 'Icon=info.cemu.Cemu' >> export/share/applications/info.cemu.Cemu.desktop"
					]
				},
				{
					"type":"script",
					"dest-filename":"cemu-updater",
					"commands":[
						"wget -qO - $(lynx -dump -listonly https://cemu.info/changelog.html | grep https | egrep '[0-9]+\.[0-9]+\.[0-9]\.zip' | awk '{print $2}' | head -n 1) > .tmp.zip",
						"unzip -qq .tmp.zip -d /tmp/",
						"rm .tmp.zip",
						"cd /tmp/cemu_*",
						"find -type d -exec mkdir -vp \"/var/data/cemu\"/{} \\; -or -exec mv -nv {} \"/var/data/cemu\"/{} \\;",
						"cd /; rm -r /tmp/cemu_*"
					]
				},
				{
					"type":"script",
					"dest-filename":"cemu",
					"commands":[
						"mkdir -p /var/data/cemu",
						"cemu-updater",
						"winetricks -q vcrun2017",
						"exec /app/bin/wine64 /var/data/cemu/Cemu.exe \"$@\""
					]
				},
				{
					"type":"extra-data",
					"url":"https://upload.wikimedia.org/wikipedia/commons/2/25/Cemu_Emulator_icon.png",
					"sha256":"392d7dc4087d2c20b7f95fd7dc1ed7042e48a20c65774e12886444edd4e4e8d9",
					"size":30549,
					"filename":"info.cemu.Cemu.png"
				},
				{
					"type":"file",
					"path":"info.cemu.Cemu.appdata.xml"
				},
				{
					"type":"file",
					"path":"info.cemu.Cemu.desktop"
				}
			]
		},
		{
			"name": "bundle-setup",
			"buildsystem": "simple",
			"build-commands": [
				"mkdir -p ${FLATPAK_DEST}/{,lib/debug/}lib/i386-linux-gnu/GL",
				"install -Dm644 -t ${FLATPAK_DEST}/etc ld.so.conf"
			],
			"sources": [
				{
					"type": "file",
					"dest-filename": "ld.so.conf",
					"url": "data:/app/lib32%0A/app/lib/i386-linux-gnu%0A"
				}
			]
		}
	]
}
